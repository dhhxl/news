# 批量生成摘要改进说明

## 问题诊断

您遇到的"批量生成摘要没有成功"问题，原因是：

**原有逻辑**：批量生成只为**没有摘要**的新闻生成摘要
- 如果所有新闻都已经有摘要，就不会重新生成
- 导致您点击"批量生成"后，看起来没有任何效果

## 改进方案

现在已经添加了 `forceRegenerate` 参数，支持两种模式：

### 模式一：仅生成缺失摘要（默认）

**适用场景**：
- 新采集的新闻还没有摘要
- 想补充生成遗漏的摘要
- 不想重新生成已有摘要

**使用方法**：
```bash
# API 调用
POST /api/summaries/generate/batch

# 或带参数
POST /api/summaries/generate/batch?forceRegenerate=false
```

### 模式二：强制重新生成所有摘要

**适用场景**：
- 更换了 AI 模型，想用新模型重新生成
- 之前的摘要质量不满意
- 修改了摘要生成的提示词

**使用方法**：
```bash
# API 调用
POST /api/summaries/generate/batch?forceRegenerate=true
```

## 如何使用

### 方法一：通过前端界面（需要修改前端）

前端需要添加一个选项：

```javascript
// 在管理后台的摘要管理页面
const generateBatchSummaries = async (forceRegenerate = false) => {
  try {
    const response = await axios.post(
      `/api/summaries/generate/batch?forceRegenerate=${forceRegenerate}`,
      {},
      { headers: { Authorization: `Bearer ${token}` }}
    );
    
    ElMessage.success(response.data.message);
  } catch (error) {
    ElMessage.error('批量生成失败');
  }
};
```

### 方法二：使用 API 测试工具（Postman/curl）

**仅生成缺失摘要**：
```bash
curl -X POST "http://localhost:8080/api/summaries/generate/batch" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json"
```

**强制重新生成所有摘要**：
```bash
curl -X POST "http://localhost:8080/api/summaries/generate/batch?forceRegenerate=true" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json"
```

### 方法三：使用 PowerShell 脚本

创建一个测试脚本：

```powershell
# 测试批量生成摘要.ps1
$baseUrl = "http://localhost:8080/api"

# 先登录获取 token
$loginData = @{
    username = "admin"
    password = "admin123"
} | ConvertTo-Json

$loginResponse = Invoke-RestMethod -Uri "$baseUrl/auth/login" `
    -Method Post `
    -ContentType "application/json" `
    -Body $loginData

$token = $loginResponse.token

# 仅生成缺失摘要
Write-Host "=== 仅生成缺失摘要 ===" -ForegroundColor Green
$response1 = Invoke-RestMethod -Uri "$baseUrl/summaries/generate/batch" `
    -Method Post `
    -Headers @{Authorization = "Bearer $token"}
Write-Host $response1.message

# 或者强制重新生成所有摘要
Write-Host "`n=== 强制重新生成所有摘要 ===" -ForegroundColor Yellow
$response2 = Invoke-RestMethod -Uri "$baseUrl/summaries/generate/batch?forceRegenerate=true" `
    -Method Post `
    -Headers @{Authorization = "Bearer $token"}
Write-Host $response2.message
```

## 新增日志功能

改进后的批量生成会输出详细日志：

```
Starting batch summary generation for all published news (forceRegenerate: true)
Found 13 published news to process
Generating summary for news 1: 新闻标题1
Generating summary for news 2: 新闻标题2
...
Batch summary generation completed: 13 generated, 0 skipped, 0 failed
```

**日志说明**：
- `generated`: 成功生成的摘要数量
- `skipped`: 跳过的数量（已有摘要且未强制重新生成）
- `failed`: 失败的数量

## 如何查看执行进度

批量生成是**异步执行**的，可以通过以下方式查看进度：

### 1. 查看后端日志

```powershell
# 实时查看日志
Get-Content backend\logs\news-management.log -Tail 20 -Wait

# 或查看最近的日志
Get-Content backend\logs\news-management.log -Tail 50
```

### 2. 查看数据库

```sql
-- 查看所有摘要
SELECT * FROM summaries;

-- 查看摘要生成状态
SELECT status, COUNT(*) as count 
FROM summaries 
GROUP BY status;

-- 查看最近生成的摘要
SELECT * FROM summaries 
ORDER BY generated_at DESC 
LIMIT 10;
```

### 3. 检查摘要数量

```bash
# API 调用：获取新闻列表（包含摘要信息）
GET /api/news
```

## 重新启动后端应用

修改代码后需要重启后端：

```batch
# 停止当前运行的后端（关闭后端窗口或按 Ctrl+C）

# 重新编译并启动
cd backend
mvn spring-boot:run
```

或者使用系统脚本：
```batch
.\stop_system.bat
.\启动系统.bat
```

## 注意事项

1. **异步执行**：批量生成是异步的，点击后会立即返回，实际生成在后台进行

2. **请求延迟**：每生成一个摘要会延迟 2 秒，避免 API 请求过快
   - 13 条新闻大约需要 26 秒

3. **API 限制**：
   - 如果没有配置 API Key，会生成模拟摘要
   - 如果 API 调用失败，会保存失败记录

4. **数据量限制**：当前一次最多处理 100 条新闻，如需处理更多请修改代码：
   ```java
   PageRequest.of(0, 100)  // 改为更大的数字
   ```

## 测试步骤

1. **重启后端服务**（应用新代码）
2. **登录管理后台**
3. **调用批量生成 API**（使用上述任一方法）
4. **查看后端日志**确认执行进度
5. **刷新前端页面**查看结果

## 问题排查

如果批量生成还是失败，检查：

1. **是否有已发布的新闻**：
   ```sql
   SELECT COUNT(*) FROM news WHERE status = 'PUBLISHED';
   ```

2. **后端日志是否有错误**：
   ```
   查看 backend/logs/news-management.log
   ```

3. **API 响应**：
   - 应返回 `{"status": "started", "message": "..."}`
   - 如果返回 403，说明权限不足
   - 如果返回 500，查看后端日志详细错误

4. **异步任务配置**：
   确保 Spring 异步任务已启用（已经在启动类添加了 `@EnableAsync`）

---

**总结**：现在批量生成摘要功能已经改进，支持两种模式。重启后端后即可使用！

