# è¯„è®ºå’Œç‚¹èµåŠŸèƒ½è¯´æ˜

## ğŸ‰ æ–°å¢åŠŸèƒ½

### 1. ç”¨æˆ·æ³¨å†Œ
- æ–°ç”¨æˆ·å¯ä»¥æ³¨å†Œè´¦å·
- æ³¨å†Œåè‡ªåŠ¨ç™»å½•
- é»˜è®¤è§’è‰²ä¸º USER

### 2. è¯„è®ºåŠŸèƒ½
- âœ… ç”¨æˆ·ç™»å½•åå¯ä»¥è¯„è®ºæ–°é—»
- âœ… ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„è¯„è®º
- âœ… ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ä»»ä½•è¯„è®º
- âœ… è¯„è®ºæ˜¾ç¤ºç”¨æˆ·åå’Œæ—¶é—´
- âœ… è¯„è®ºæŒ‰æ—¶é—´å€’åºæ’åˆ—

### 3. ç‚¹èµåŠŸèƒ½
- âœ… ç”¨æˆ·ç™»å½•åå¯ä»¥ç‚¹èµæ–°é—»
- âœ… ç”¨æˆ·å¯ä»¥å–æ¶ˆç‚¹èµ
- âœ… æ˜¾ç¤ºç‚¹èµæ€»æ•°
- âœ… æ˜¾ç¤ºç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ

### 4. æƒé™åŒºåˆ†
- **æ¸¸å®¢**ï¼šå¯ä»¥æµè§ˆæ–°é—»ã€æŸ¥çœ‹è¯„è®ºå’Œç‚¹èµæ•°
- **æ™®é€šç”¨æˆ·**ï¼šå¯ä»¥è¯„è®ºã€ç‚¹èµ
- **ç®¡ç†å‘˜**ï¼šå¯ä»¥ç®¡ç†æ‰€æœ‰å†…å®¹

## ğŸ“Š æ•°æ®åº“å˜æ›´

### æ–°å¢è¡¨

#### 1. commentsï¼ˆè¯„è®ºè¡¨ï¼‰
```sql
CREATE TABLE comments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    news_id BIGINT NOT NULL,          -- æ–°é—»ID
    user_id BIGINT NOT NULL,          -- ç”¨æˆ·ID
    content TEXT NOT NULL,            -- è¯„è®ºå†…å®¹
    status VARCHAR(20) DEFAULT 'APPROVED',  -- çŠ¶æ€
    created_at TIMESTAMP,             -- åˆ›å»ºæ—¶é—´
    updated_at TIMESTAMP              -- æ›´æ–°æ—¶é—´
);
```

#### 2. likesï¼ˆç‚¹èµè¡¨ï¼‰
```sql
CREATE TABLE likes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    news_id BIGINT NOT NULL,          -- æ–°é—»ID
    user_id BIGINT NOT NULL,          -- ç”¨æˆ·ID
    created_at TIMESTAMP,             -- ç‚¹èµæ—¶é—´
    UNIQUE KEY (news_id, user_id)    -- ä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡
);
```

### ä¿®æ”¹è¡¨

#### newsè¡¨æ–°å¢å­—æ®µ
```sql
ALTER TABLE news ADD COLUMN like_count INT DEFAULT 0;     -- ç‚¹èµæ•°
ALTER TABLE news ADD COLUMN comment_count INT DEFAULT 0;  -- è¯„è®ºæ•°
```

## ğŸ”Œ API æ¥å£

### 1. ç”¨æˆ·æ³¨å†Œ
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "newuser",
  "password": "password123",
  "email": "user@example.com"
}

Response:
{
  "token": "eyJhbGci...",
  "refreshToken": "eyJhbGci...",
  "userId": 2,
  "username": "newuser",
  "role": "USER"
}
```

### 2. è¯„è®ºç›¸å…³

#### åˆ›å»ºè¯„è®ºï¼ˆéœ€ç™»å½•ï¼‰
```http
POST /api/comments
Authorization: Bearer {token}
Content-Type: application/json

{
  "newsId": 1,
  "content": "è¿™æ˜¯ä¸€æ¡è¯„è®º"
}
```

#### è·å–æ–°é—»è¯„è®ºï¼ˆå…¬å¼€ï¼‰
```http
GET /api/comments/news/{newsId}

Response:
[
  {
    "id": 1,
    "newsId": 1,
    "userId": 2,
    "username": "user1",
    "content": "è¿™æ˜¯ä¸€æ¡è¯„è®º",
    "status": "APPROVED",
    "createdAt": "2025-10-14T10:00:00",
    "updatedAt": "2025-10-14T10:00:00"
  }
]
```

#### åˆ é™¤è¯„è®ºï¼ˆéœ€ç™»å½•ï¼Œä½œè€…æˆ–ç®¡ç†å‘˜ï¼‰
```http
DELETE /api/comments/{commentId}
Authorization: Bearer {token}
```

#### ç»Ÿè®¡è¯„è®ºæ•°ï¼ˆå…¬å¼€ï¼‰
```http
GET /api/comments/news/{newsId}/count

Response:
{
  "count": 5
}
```

### 3. ç‚¹èµç›¸å…³

#### ç‚¹èµæ–°é—»ï¼ˆéœ€ç™»å½•ï¼‰
```http
POST /api/likes/news/{newsId}
Authorization: Bearer {token}

Response:
{
  "message": "ç‚¹èµæˆåŠŸ"
}
```

#### å–æ¶ˆç‚¹èµï¼ˆéœ€ç™»å½•ï¼‰
```http
DELETE /api/likes/news/{newsId}
Authorization: Bearer {token}

Response:
{
  "message": "å·²å–æ¶ˆç‚¹èµ"
}
```

#### æ£€æŸ¥ç‚¹èµçŠ¶æ€ï¼ˆéœ€ç™»å½•ï¼‰
```http
GET /api/likes/news/{newsId}/status
Authorization: Bearer {token}

Response:
{
  "liked": true
}
```

#### è·å–ç‚¹èµæ•°ï¼ˆå…¬å¼€ï¼‰
```http
GET /api/likes/news/{newsId}/count

Response:
{
  "count": 10
}
```

## ğŸ”§ åç«¯å®ç°

### æ–°å¢æ–‡ä»¶

#### å®ä½“ç±»
- `Comment.java` - è¯„è®ºå®ä½“
- `Like.java` - ç‚¹èµå®ä½“

#### Repository
- `CommentRepository.java` - è¯„è®ºæ•°æ®è®¿é—®
- `LikeRepository.java` - ç‚¹èµæ•°æ®è®¿é—®

#### Service
- `CommentService.java` - è¯„è®ºä¸šåŠ¡é€»è¾‘
- `LikeService.java` - ç‚¹èµä¸šåŠ¡é€»è¾‘

#### Controller
- `CommentController.java` - è¯„è®ºAPI
- `LikeController.java` - ç‚¹èµAPI

#### æ•°æ®åº“è¿ç§»
- `V8__add_comments_and_likes.sql` - åˆ›å»ºè¡¨å’Œå­—æ®µ

### ä¿®æ”¹æ–‡ä»¶
- `AuthController.java` - æ·»åŠ æ³¨å†ŒåŠŸèƒ½
- `UserService.java` - æ·»åŠ åˆ›å»ºç”¨æˆ·æ–¹æ³•
- `SecurityConfig.java` - æ›´æ–°æƒé™é…ç½®
- `News.java` - æ·»åŠ ç‚¹èµæ•°å’Œè¯„è®ºæ•°å­—æ®µ

## ğŸš€ å¯åŠ¨æ­¥éª¤

### 1. åœæ­¢åç«¯
å¦‚æœåç«¯æ­£åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢ï¼š
- å…³é—­åç«¯çª—å£æˆ–æŒ‰ Ctrl+C

### 2. é‡æ–°ç¼–è¯‘å¹¶å¯åŠ¨
```batch
cd E:\æ¯•ä¸šè®¾è®¡\News_website\backend
mvn clean compile spring-boot:run
```

### 3. æ•°æ®åº“è¿ç§»
åç«¯å¯åŠ¨æ—¶ï¼ŒFlywayä¼šè‡ªåŠ¨æ‰§è¡ŒV8è¿ç§»è„šæœ¬ï¼Œåˆ›å»ºcommentså’Œlikesè¡¨ã€‚

### 4. éªŒè¯åŠŸèƒ½
å¯åŠ¨å®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨APIæµ‹è¯•å·¥å…·ï¼ˆå¦‚Postmanï¼‰æµ‹è¯•åŠŸèƒ½ï¼š
1. æ³¨å†Œæ–°ç”¨æˆ·
2. ç™»å½•è·å–token
3. ä½¿ç”¨tokenåˆ›å»ºè¯„è®º
4. ä½¿ç”¨tokenç‚¹èµæ–°é—»

## ğŸ“± å‰ç«¯é›†æˆï¼ˆå¾…å¼€å‘ï¼‰

å‰ç«¯éœ€è¦æ·»åŠ ä»¥ä¸‹UIç»„ä»¶ï¼š

### 1. æ³¨å†Œé¡µé¢
- ç”¨æˆ·åè¾“å…¥æ¡†
- å¯†ç è¾“å…¥æ¡†
- é‚®ç®±è¾“å…¥æ¡†
- æ³¨å†ŒæŒ‰é’®

### 2. æ–°é—»è¯¦æƒ…é¡µå¢å¼º
```vue
<template>
  <div class="news-detail">
    <!-- æ–°é—»å†…å®¹ -->
    <div class="news-content">...</div>
    
    <!-- ç‚¹èµå’Œåˆ†äº« -->
    <div class="news-actions">
      <button @click="toggleLike" :class="{ liked: isLiked }">
        <i class="icon-like"></i>
        ç‚¹èµ ({{ likeCount }})
      </button>
      <span>è¯„è®º ({{ commentCount }})</span>
    </div>
    
    <!-- è¯„è®ºåŒº -->
    <div class="comments-section">
      <h3>è¯„è®º</h3>
      
      <!-- å‘è¡¨è¯„è®º -->
      <div v-if="isLoggedIn" class="comment-form">
        <textarea v-model="commentContent" placeholder="å‘è¡¨ä½ çš„çœ‹æ³•..."></textarea>
        <button @click="submitComment">å‘è¡¨è¯„è®º</button>
      </div>
      <div v-else class="login-prompt">
        <router-link to="/login">ç™»å½•</router-link> åå‘è¡¨è¯„è®º
      </div>
      
      <!-- è¯„è®ºåˆ—è¡¨ -->
      <div class="comment-list">
        <div v-for="comment in comments" :key="comment.id" class="comment-item">
          <div class="comment-header">
            <span class="username">{{ comment.username }}</span>
            <span class="time">{{ formatTime(comment.createdAt) }}</span>
          </div>
          <div class="comment-content">{{ comment.content }}</div>
          <div v-if="canDeleteComment(comment)" class="comment-actions">
            <button @click="deleteComment(comment.id)">åˆ é™¤</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import axios from 'axios'

const route = useRoute()
const newsId = route.params.id

const isLiked = ref(false)
const likeCount = ref(0)
const commentCount = ref(0)
const comments = ref([])
const commentContent = ref('')
const isLoggedIn = ref(false)

// åŠ è½½ç‚¹èµçŠ¶æ€
async function loadLikeStatus() {
  if (!isLoggedIn.value) return
  
  try {
    const response = await axios.get(`/likes/news/${newsId}/status`)
    isLiked.value = response.data.liked
  } catch (error) {
    console.error('Failed to load like status', error)
  }
}

// åŠ è½½ç‚¹èµæ•°
async function loadLikeCount() {
  try {
    const response = await axios.get(`/likes/news/${newsId}/count`)
    likeCount.value = response.data.count
  } catch (error) {
    console.error('Failed to load like count', error)
  }
}

// åˆ‡æ¢ç‚¹èµ
async function toggleLike() {
  if (!isLoggedIn.value) {
    // è·³è½¬åˆ°ç™»å½•é¡µ
    return
  }
  
  try {
    if (isLiked.value) {
      await axios.delete(`/likes/news/${newsId}`)
      isLiked.value = false
      likeCount.value--
    } else {
      await axios.post(`/likes/news/${newsId}`)
      isLiked.value = true
      likeCount.value++
    }
  } catch (error) {
    console.error('Failed to toggle like', error)
  }
}

// åŠ è½½è¯„è®º
async function loadComments() {
  try {
    const response = await axios.get(`/comments/news/${newsId}`)
    comments.value = response.data
    commentCount.value = response.data.length
  } catch (error) {
    console.error('Failed to load comments', error)
  }
}

// æäº¤è¯„è®º
async function submitComment() {
  if (!commentContent.value.trim()) return
  
  try {
    await axios.post('/comments', {
      newsId: newsId,
      content: commentContent.value
    })
    
    commentContent.value = ''
    await loadComments()
  } catch (error) {
    console.error('Failed to submit comment', error)
  }
}

// åˆ é™¤è¯„è®º
async function deleteComment(commentId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return
  
  try {
    await axios.delete(`/comments/${commentId}`)
    await loadComments()
  } catch (error) {
    console.error('Failed to delete comment', error)
  }
}

// æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ é™¤è¯„è®º
function canDeleteComment(comment) {
  // å®ç°é€»è¾‘ï¼šç”¨æˆ·è‡ªå·±çš„è¯„è®ºæˆ–ç®¡ç†å‘˜å¯ä»¥åˆ é™¤
  return true // ç®€åŒ–å¤„ç†
}

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(time) {
  // å®ç°æ—¶é—´æ ¼å¼åŒ–
  return new Date(time).toLocaleString('zh-CN')
}

onMounted(() => {
  loadLikeStatus()
  loadLikeCount()
  loadComments()
})
</script>
```

### 3. æ³¨å†Œé¡µé¢
åˆ›å»º `frontend/src/views/Register.vue`

```vue
<template>
  <div class="register-container">
    <el-card class="register-card">
      <h2>ç”¨æˆ·æ³¨å†Œ</h2>
      <el-form :model="form" :rules="rules" ref="formRef">
        <el-form-item prop="username">
          <el-input v-model="form.username" placeholder="ç”¨æˆ·å" />
        </el-form-item>
        <el-form-item prop="email">
          <el-input v-model="form.email" type="email" placeholder="é‚®ç®±" />
        </el-form-item>
        <el-form-item prop="password">
          <el-input v-model="form.password" type="password" placeholder="å¯†ç " />
        </el-form-item>
        <el-form-item prop="confirmPassword">
          <el-input v-model="form.confirmPassword" type="password" placeholder="ç¡®è®¤å¯†ç " />
        </el-form-item>
        <el-button type="primary" @click="handleRegister" :loading="loading">
          æ³¨å†Œ
        </el-button>
      </el-form>
      <div class="login-link">
        å·²æœ‰è´¦å·ï¼Ÿ<router-link to="/login">ç«‹å³ç™»å½•</router-link>
      </div>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'
import { ElMessage } from 'element-plus'

const router = useRouter()
const formRef = ref()
const loading = ref(false)

const form = ref({
  username: '',
  email: '',
  password: '',
  confirmPassword: ''
})

const rules = {
  username: [
    { required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å', trigger: 'blur' }
  ],
  email: [
    { required: true, message: 'è¯·è¾“å…¥é‚®ç®±', trigger: 'blur' },
    { type: 'email', message: 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼', trigger: 'blur' }
  ],
  password: [
    { required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' },
    { min: 6, message: 'å¯†ç è‡³å°‘6ä½', trigger: 'blur' }
  ],
  confirmPassword: [
    { required: true, message: 'è¯·ç¡®è®¤å¯†ç ', trigger: 'blur' },
    {
      validator: (rule, value, callback) => {
        if (value !== form.value.password) {
          callback(new Error('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´'))
        } else {
          callback()
        }
      },
      trigger: 'blur'
    }
  ]
}

async function handleRegister() {
  await formRef.value.validate()
  
  loading.value = true
  try {
    const response = await axios.post('/auth/register', {
      username: form.value.username,
      email: form.value.email,
      password: form.value.password
    })
    
    // ä¿å­˜token
    localStorage.setItem('token', response.data.token)
    localStorage.setItem('refreshToken', response.data.refreshToken)
    
    ElMessage.success('æ³¨å†ŒæˆåŠŸï¼')
    router.push('/')
  } catch (error) {
    ElMessage.error(error.response?.data?.message || 'æ³¨å†Œå¤±è´¥')
  } finally {
    loading.value = false
  }
}
</script>
```

## âœ… æµ‹è¯•æ¸…å•

### åç«¯æµ‹è¯•
- [ ] V8è¿ç§»è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] å¯ä»¥æ³¨å†Œæ–°ç”¨æˆ·
- [ ] å¯ä»¥åˆ›å»ºè¯„è®º
- [ ] å¯ä»¥åˆ é™¤è¯„è®º
- [ ] å¯ä»¥ç‚¹èµæ–°é—»
- [ ] å¯ä»¥å–æ¶ˆç‚¹èµ
- [ ] ç‚¹èµå’Œè¯„è®ºæ•°æ­£ç¡®ç»Ÿè®¡

### å‰ç«¯æµ‹è¯•ï¼ˆå¾…å¼€å‘ï¼‰
- [ ] æ³¨å†Œé¡µé¢æ­£å¸¸æ˜¾ç¤º
- [ ] æ³¨å†ŒåŠŸèƒ½æ­£å¸¸
- [ ] æ–°é—»è¯¦æƒ…é¡µæ˜¾ç¤ºè¯„è®ºåŒº
- [ ] å¯ä»¥å‘è¡¨è¯„è®º
- [ ] å¯ä»¥ç‚¹èµ/å–æ¶ˆç‚¹èµ
- [ ] è¯„è®ºå’Œç‚¹èµæ•°å®æ—¶æ›´æ–°

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æƒé™æ§åˆ¶**
   - è¯„è®ºå’Œç‚¹èµéœ€è¦ç™»å½•
   - åªèƒ½åˆ é™¤è‡ªå·±çš„è¯„è®ºï¼ˆç®¡ç†å‘˜é™¤å¤–ï¼‰
   - åŒä¸€ç”¨æˆ·å¯¹åŒä¸€æ–°é—»åªèƒ½ç‚¹èµä¸€æ¬¡

2. **æ•°æ®ä¸€è‡´æ€§**
   - è¯„è®ºå’Œç‚¹èµä¼šå…³è”åˆ°news_idå’Œuser_id
   - åˆ é™¤æ–°é—»æ—¶ä¼šçº§è”åˆ é™¤è¯„è®ºå’Œç‚¹èµ

3. **æ€§èƒ½è€ƒè™‘**
   - è¯„è®ºæŒ‰æ—¶é—´å€’åºæŸ¥è¯¢å¹¶æœ‰ç´¢å¼•
   - ç‚¹èµä½¿ç”¨å”¯ä¸€ç´¢å¼•é˜²æ­¢é‡å¤

4. **å®‰å…¨æ€§**
   - æ‰€æœ‰å†™æ“ä½œéƒ½éœ€è¦JWTè®¤è¯
   - é˜²æ­¢SQLæ³¨å…¥å’ŒXSSæ”»å‡»

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿé‡å¯åç«¯å¼€å§‹æµ‹è¯•ï¼** ğŸš€

```batch
cd E:\æ¯•ä¸šè®¾è®¡\News_website\backend
mvn clean compile spring-boot:run
```

