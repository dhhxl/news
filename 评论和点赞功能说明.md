# 评论和点赞功能说明

## 🎉 新增功能

### 1. 用户注册
- 新用户可以注册账号
- 注册后自动登录
- 默认角色为 USER

### 2. 评论功能
- ✅ 用户登录后可以评论新闻
- ✅ 用户可以删除自己的评论
- ✅ 管理员可以删除任何评论
- ✅ 评论显示用户名和时间
- ✅ 评论按时间倒序排列

### 3. 点赞功能
- ✅ 用户登录后可以点赞新闻
- ✅ 用户可以取消点赞
- ✅ 显示点赞总数
- ✅ 显示用户是否已点赞

### 4. 权限区分
- **游客**：可以浏览新闻、查看评论和点赞数
- **普通用户**：可以评论、点赞
- **管理员**：可以管理所有内容

## 📊 数据库变更

### 新增表

#### 1. comments（评论表）
```sql
CREATE TABLE comments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    news_id BIGINT NOT NULL,          -- 新闻ID
    user_id BIGINT NOT NULL,          -- 用户ID
    content TEXT NOT NULL,            -- 评论内容
    status VARCHAR(20) DEFAULT 'APPROVED',  -- 状态
    created_at TIMESTAMP,             -- 创建时间
    updated_at TIMESTAMP              -- 更新时间
);
```

#### 2. likes（点赞表）
```sql
CREATE TABLE likes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    news_id BIGINT NOT NULL,          -- 新闻ID
    user_id BIGINT NOT NULL,          -- 用户ID
    created_at TIMESTAMP,             -- 点赞时间
    UNIQUE KEY (news_id, user_id)    -- 一个用户只能点赞一次
);
```

### 修改表

#### news表新增字段
```sql
ALTER TABLE news ADD COLUMN like_count INT DEFAULT 0;     -- 点赞数
ALTER TABLE news ADD COLUMN comment_count INT DEFAULT 0;  -- 评论数
```

## 🔌 API 接口

### 1. 用户注册
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "newuser",
  "password": "password123",
  "email": "user@example.com"
}

Response:
{
  "token": "eyJhbGci...",
  "refreshToken": "eyJhbGci...",
  "userId": 2,
  "username": "newuser",
  "role": "USER"
}
```

### 2. 评论相关

#### 创建评论（需登录）
```http
POST /api/comments
Authorization: Bearer {token}
Content-Type: application/json

{
  "newsId": 1,
  "content": "这是一条评论"
}
```

#### 获取新闻评论（公开）
```http
GET /api/comments/news/{newsId}

Response:
[
  {
    "id": 1,
    "newsId": 1,
    "userId": 2,
    "username": "user1",
    "content": "这是一条评论",
    "status": "APPROVED",
    "createdAt": "2025-10-14T10:00:00",
    "updatedAt": "2025-10-14T10:00:00"
  }
]
```

#### 删除评论（需登录，作者或管理员）
```http
DELETE /api/comments/{commentId}
Authorization: Bearer {token}
```

#### 统计评论数（公开）
```http
GET /api/comments/news/{newsId}/count

Response:
{
  "count": 5
}
```

### 3. 点赞相关

#### 点赞新闻（需登录）
```http
POST /api/likes/news/{newsId}
Authorization: Bearer {token}

Response:
{
  "message": "点赞成功"
}
```

#### 取消点赞（需登录）
```http
DELETE /api/likes/news/{newsId}
Authorization: Bearer {token}

Response:
{
  "message": "已取消点赞"
}
```

#### 检查点赞状态（需登录）
```http
GET /api/likes/news/{newsId}/status
Authorization: Bearer {token}

Response:
{
  "liked": true
}
```

#### 获取点赞数（公开）
```http
GET /api/likes/news/{newsId}/count

Response:
{
  "count": 10
}
```

## 🔧 后端实现

### 新增文件

#### 实体类
- `Comment.java` - 评论实体
- `Like.java` - 点赞实体

#### Repository
- `CommentRepository.java` - 评论数据访问
- `LikeRepository.java` - 点赞数据访问

#### Service
- `CommentService.java` - 评论业务逻辑
- `LikeService.java` - 点赞业务逻辑

#### Controller
- `CommentController.java` - 评论API
- `LikeController.java` - 点赞API

#### 数据库迁移
- `V8__add_comments_and_likes.sql` - 创建表和字段

### 修改文件
- `AuthController.java` - 添加注册功能
- `UserService.java` - 添加创建用户方法
- `SecurityConfig.java` - 更新权限配置
- `News.java` - 添加点赞数和评论数字段

## 🚀 启动步骤

### 1. 停止后端
如果后端正在运行，先停止：
- 关闭后端窗口或按 Ctrl+C

### 2. 重新编译并启动
```batch
cd E:\毕业设计\News_website\backend
mvn clean compile spring-boot:run
```

### 3. 数据库迁移
后端启动时，Flyway会自动执行V8迁移脚本，创建comments和likes表。

### 4. 验证功能
启动完成后，可以使用API测试工具（如Postman）测试功能：
1. 注册新用户
2. 登录获取token
3. 使用token创建评论
4. 使用token点赞新闻

## 📱 前端集成（待开发）

前端需要添加以下UI组件：

### 1. 注册页面
- 用户名输入框
- 密码输入框
- 邮箱输入框
- 注册按钮

### 2. 新闻详情页增强
```vue
<template>
  <div class="news-detail">
    <!-- 新闻内容 -->
    <div class="news-content">...</div>
    
    <!-- 点赞和分享 -->
    <div class="news-actions">
      <button @click="toggleLike" :class="{ liked: isLiked }">
        <i class="icon-like"></i>
        点赞 ({{ likeCount }})
      </button>
      <span>评论 ({{ commentCount }})</span>
    </div>
    
    <!-- 评论区 -->
    <div class="comments-section">
      <h3>评论</h3>
      
      <!-- 发表评论 -->
      <div v-if="isLoggedIn" class="comment-form">
        <textarea v-model="commentContent" placeholder="发表你的看法..."></textarea>
        <button @click="submitComment">发表评论</button>
      </div>
      <div v-else class="login-prompt">
        <router-link to="/login">登录</router-link> 后发表评论
      </div>
      
      <!-- 评论列表 -->
      <div class="comment-list">
        <div v-for="comment in comments" :key="comment.id" class="comment-item">
          <div class="comment-header">
            <span class="username">{{ comment.username }}</span>
            <span class="time">{{ formatTime(comment.createdAt) }}</span>
          </div>
          <div class="comment-content">{{ comment.content }}</div>
          <div v-if="canDeleteComment(comment)" class="comment-actions">
            <button @click="deleteComment(comment.id)">删除</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import axios from 'axios'

const route = useRoute()
const newsId = route.params.id

const isLiked = ref(false)
const likeCount = ref(0)
const commentCount = ref(0)
const comments = ref([])
const commentContent = ref('')
const isLoggedIn = ref(false)

// 加载点赞状态
async function loadLikeStatus() {
  if (!isLoggedIn.value) return
  
  try {
    const response = await axios.get(`/likes/news/${newsId}/status`)
    isLiked.value = response.data.liked
  } catch (error) {
    console.error('Failed to load like status', error)
  }
}

// 加载点赞数
async function loadLikeCount() {
  try {
    const response = await axios.get(`/likes/news/${newsId}/count`)
    likeCount.value = response.data.count
  } catch (error) {
    console.error('Failed to load like count', error)
  }
}

// 切换点赞
async function toggleLike() {
  if (!isLoggedIn.value) {
    // 跳转到登录页
    return
  }
  
  try {
    if (isLiked.value) {
      await axios.delete(`/likes/news/${newsId}`)
      isLiked.value = false
      likeCount.value--
    } else {
      await axios.post(`/likes/news/${newsId}`)
      isLiked.value = true
      likeCount.value++
    }
  } catch (error) {
    console.error('Failed to toggle like', error)
  }
}

// 加载评论
async function loadComments() {
  try {
    const response = await axios.get(`/comments/news/${newsId}`)
    comments.value = response.data
    commentCount.value = response.data.length
  } catch (error) {
    console.error('Failed to load comments', error)
  }
}

// 提交评论
async function submitComment() {
  if (!commentContent.value.trim()) return
  
  try {
    await axios.post('/comments', {
      newsId: newsId,
      content: commentContent.value
    })
    
    commentContent.value = ''
    await loadComments()
  } catch (error) {
    console.error('Failed to submit comment', error)
  }
}

// 删除评论
async function deleteComment(commentId) {
  if (!confirm('确定要删除这条评论吗？')) return
  
  try {
    await axios.delete(`/comments/${commentId}`)
    await loadComments()
  } catch (error) {
    console.error('Failed to delete comment', error)
  }
}

// 检查是否可以删除评论
function canDeleteComment(comment) {
  // 实现逻辑：用户自己的评论或管理员可以删除
  return true // 简化处理
}

// 格式化时间
function formatTime(time) {
  // 实现时间格式化
  return new Date(time).toLocaleString('zh-CN')
}

onMounted(() => {
  loadLikeStatus()
  loadLikeCount()
  loadComments()
})
</script>
```

### 3. 注册页面
创建 `frontend/src/views/Register.vue`

```vue
<template>
  <div class="register-container">
    <el-card class="register-card">
      <h2>用户注册</h2>
      <el-form :model="form" :rules="rules" ref="formRef">
        <el-form-item prop="username">
          <el-input v-model="form.username" placeholder="用户名" />
        </el-form-item>
        <el-form-item prop="email">
          <el-input v-model="form.email" type="email" placeholder="邮箱" />
        </el-form-item>
        <el-form-item prop="password">
          <el-input v-model="form.password" type="password" placeholder="密码" />
        </el-form-item>
        <el-form-item prop="confirmPassword">
          <el-input v-model="form.confirmPassword" type="password" placeholder="确认密码" />
        </el-form-item>
        <el-button type="primary" @click="handleRegister" :loading="loading">
          注册
        </el-button>
      </el-form>
      <div class="login-link">
        已有账号？<router-link to="/login">立即登录</router-link>
      </div>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'
import { ElMessage } from 'element-plus'

const router = useRouter()
const formRef = ref()
const loading = ref(false)

const form = ref({
  username: '',
  email: '',
  password: '',
  confirmPassword: ''
})

const rules = {
  username: [
    { required: true, message: '请输入用户名', trigger: 'blur' }
  ],
  email: [
    { required: true, message: '请输入邮箱', trigger: 'blur' },
    { type: 'email', message: '请输入正确的邮箱格式', trigger: 'blur' }
  ],
  password: [
    { required: true, message: '请输入密码', trigger: 'blur' },
    { min: 6, message: '密码至少6位', trigger: 'blur' }
  ],
  confirmPassword: [
    { required: true, message: '请确认密码', trigger: 'blur' },
    {
      validator: (rule, value, callback) => {
        if (value !== form.value.password) {
          callback(new Error('两次密码不一致'))
        } else {
          callback()
        }
      },
      trigger: 'blur'
    }
  ]
}

async function handleRegister() {
  await formRef.value.validate()
  
  loading.value = true
  try {
    const response = await axios.post('/auth/register', {
      username: form.value.username,
      email: form.value.email,
      password: form.value.password
    })
    
    // 保存token
    localStorage.setItem('token', response.data.token)
    localStorage.setItem('refreshToken', response.data.refreshToken)
    
    ElMessage.success('注册成功！')
    router.push('/')
  } catch (error) {
    ElMessage.error(error.response?.data?.message || '注册失败')
  } finally {
    loading.value = false
  }
}
</script>
```

## ✅ 测试清单

### 后端测试
- [ ] V8迁移脚本执行成功
- [ ] 可以注册新用户
- [ ] 可以创建评论
- [ ] 可以删除评论
- [ ] 可以点赞新闻
- [ ] 可以取消点赞
- [ ] 点赞和评论数正确统计

### 前端测试（待开发）
- [ ] 注册页面正常显示
- [ ] 注册功能正常
- [ ] 新闻详情页显示评论区
- [ ] 可以发表评论
- [ ] 可以点赞/取消点赞
- [ ] 评论和点赞数实时更新

## 📝 注意事项

1. **权限控制**
   - 评论和点赞需要登录
   - 只能删除自己的评论（管理员除外）
   - 同一用户对同一新闻只能点赞一次

2. **数据一致性**
   - 评论和点赞会关联到news_id和user_id
   - 删除新闻时会级联删除评论和点赞

3. **性能考虑**
   - 评论按时间倒序查询并有索引
   - 点赞使用唯一索引防止重复

4. **安全性**
   - 所有写操作都需要JWT认证
   - 防止SQL注入和XSS攻击

---

**准备好了吗？重启后端开始测试！** 🚀

```batch
cd E:\毕业设计\News_website\backend
mvn clean compile spring-boot:run
```

