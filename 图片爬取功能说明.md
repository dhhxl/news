# 图片爬取功能说明

## ✅ 功能实现

### 新增功能
- ✅ 爬虫自动爬取新闻配图
- ✅ 存储图片URL到数据库
- ✅ 前端列表页显示缩略图
- ✅ 前端详情页显示大图
- ✅ 图片加载失败优雅降级

---

## 📊 实现细节

### 1. 数据库变更

#### V10迁移脚本
```sql
-- 为news表添加图片URL字段
ALTER TABLE news ADD COLUMN image_url VARCHAR(500) COMMENT '新闻配图URL';

-- 创建索引
CREATE INDEX idx_news_image_url ON news(image_url);
```

### 2. 后端实现

#### News实体类
```java
@Column(name = "image_url", length = 500)
private String imageUrl;
```

#### 爬虫逻辑（CctvNewsCrawler）
```java
// 提取图片URL
String imageUrl = null;
Element imageElement = doc.selectFirst("div.content_area img, div.cnt_bd img, img.lazy");
if (imageElement != null) {
    imageUrl = imageElement.attr("abs:src");
    if (imageUrl == null || imageUrl.isEmpty()) {
        imageUrl = imageElement.attr("data-src"); // 懒加载图片
    }
}
```

#### 支持的图片来源
1. **央视新闻**: `div.content_area img, div.cnt_bd img`
2. **网易新闻**: `div.post_body img, div.post_text img`
3. **懒加载图片**: 支持`data-src`属性

### 3. 前端实现

#### TypeScript接口
```typescript
export interface News {
  // ... 其他字段
  imageUrl?: string  // 新增图片URL字段
  likeCount?: number
  commentCount?: number
}
```

#### 新闻列表页
```vue
<!-- 左侧图片 -->
<div v-if="news.imageUrl" class="news-image">
  <img :src="news.imageUrl" :alt="news.title" />
</div>

<!-- 右侧内容 -->
<div class="news-content">
  <h3>{{ news.title }}</h3>
  <p>{{ news.content }}</p>
  <!-- 元信息：包含点赞数、评论数 -->
</div>
```

#### 新闻详情页
```vue
<!-- 新闻配图 -->
<div v-if="news.imageUrl" class="news-image">
  <img :src="news.imageUrl" :alt="news.title" />
</div>
```

---

## 🎨 UI设计

### 新闻列表卡片
```
┌─────────────────────────────────────┐
│  [图片]   标题                       │
│  200x150  内容摘要...                │
│          来源 | 时间 | 阅读 | 点赞 | 评论 │
└─────────────────────────────────────┘
```

**特点**：
- 左图右文布局
- 图片固定尺寸200x150
- hover时图片放大1.05倍
- 卡片hover时上浮效果

### 新闻详情页
```
┌─────────────────────┐
│      标题           │
│  来源 | 时间 | 阅读  │
│                     │
│    [新闻配图]       │
│   (宽度100%，       │
│    最大800px)       │
│                     │
│   AI摘要            │
│   正文内容          │
└─────────────────────┘
```

**特点**：
- 图片居中显示
- 响应式宽度（100%，最大800px）
- 保持原始宽高比

---

## 🔧 技术细节

### 图片URL提取策略

#### 1. 优先级顺序
```
1. img标签的src属性（绝对路径）
2. img标签的data-src属性（懒加载）
3. 如果都为空，则不设置图片
```

#### 2. 绝对路径处理
```java
imageUrl = imageElement.attr("abs:src");  // Jsoup自动转为绝对路径
```

#### 3. 懒加载支持
```java
if (imageUrl == null || imageUrl.isEmpty()) {
    imageUrl = imageElement.attr("data-src");
}
```

### CSS样式特性

#### 列表页图片样式
```css
.news-image {
  width: 200px;
  height: 150px;
  object-fit: cover;  /* 裁剪填充 */
  border-radius: 6px;
}
```

#### 详情页图片样式
```css
.news-image {
  width: 100%;
  max-width: 800px;
  margin: 20px auto;
  object-fit: contain;  /* 完整显示 */
}
```

#### Hover效果
```css
.news-card:hover .news-image img {
  transform: scale(1.05);  /* 图片放大 */
}
```

---

## 🚀 启动和测试

### 1. 重启后端（应用数据库迁移）

```batch
cd E:\毕业设计\News_website

# 停止现有后端进程
jps -l | Select-String "NewsManagement"
taskkill /F /PID {进程ID}

# 重新启动
cd backend
mvn spring-boot:run
```

后端启动时会自动执行V10迁移脚本，添加`image_url`字段。

### 2. 重新采集新闻（获取图片）

```powershell
# 运行初始化脚本
.\init_test_data.ps1
```

或手动触发：
1. 登录管理后台
2. 进入"采集管理"
3. 点击"触发爬虫"

### 3. 查看效果

访问 http://localhost:5173

**新闻列表页**：
- 有图片的新闻显示缩略图（左侧）
- 没有图片的新闻只显示文字

**新闻详情页**：
- 标题下方显示大图
- 图片居中，自适应宽度

---

## 📝 图片爬取规则

### 选择器优先级

#### 央视新闻
```java
"div.content_area img"  // 内容区域图片
"div.cnt_bd img"        // 内容主体图片
"img.lazy"              // 懒加载图片
```

#### 网易新闻
```java
"div.post_body img"     // 文章主体图片
"div.post_text img"     // 文章文本图片
"img.lazyload"          // 懒加载图片
```

### 图片URL处理

1. **绝对路径**: 使用`attr("abs:src")`自动转为绝对URL
2. **懒加载**: 检查`data-src`属性
3. **验证**: 确保URL不为空且有效
4. **日志**: 记录找到的图片URL（DEBUG级别）

---

## 🎯 测试清单

### 后端测试
- [ ] V10迁移脚本执行成功
- [ ] news表有image_url字段
- [ ] 爬虫能爬取到图片URL
- [ ] 图片URL存入数据库
- [ ] API返回包含imageUrl字段

### 前端测试
- [ ] 新闻列表显示图片
- [ ] 图片缩略图尺寸正确（200x150）
- [ ] hover时图片有放大效果
- [ ] 详情页图片正常显示
- [ ] 没有图片的新闻正常显示（不显示图片区域）
- [ ] 图片加载失败时不影响页面

---

## 🐛 常见问题

### Q: 爬取的新闻没有图片？
**A**: 
- 部分新闻网站可能没有配图
- 选择器可能需要调整（不同新闻页面结构不同）
- 图片可能是动态加载的，需要特殊处理

### Q: 图片显示不出来？
**A**:
- 检查图片URL是否有效
- 某些图片可能有防盗链（需要设置Referer）
- 图片URL可能过期
- 浏览器控制台查看是否有CORS错误

### Q: 如何修改图片选择器？
**A**: 
修改爬虫文件中的选择器：
```java
// CctvNewsCrawler.java 第156行
Element imageElement = doc.selectFirst("你的选择器");
```

### Q: 如何支持多张图片？
**A**: 
当前实现只抓取第一张图片。如需多张图片：
1. 数据库改为存储JSON数组
2. 爬虫改为selectAll获取所有图片
3. 前端使用轮播图组件展示

---

## 📈 后续优化建议

### 1. 图片本地化存储
当前存储的是原网站的图片URL，可能存在以下问题：
- 图片可能失效
- 加载速度慢
- 存在防盗链

**优化方案**：
- 下载图片到本地服务器
- 使用OSS（如阿里云OSS、七牛云）
- 图片CDN加速

### 2. 图片压缩
- 使用图片压缩服务
- 生成多种尺寸（缩略图、中图、大图）
- 节省带宽和存储空间

### 3. 懒加载优化
```vue
<img 
  :src="news.imageUrl" 
  loading="lazy"  <!-- 浏览器原生懒加载 -->
  :alt="news.title" 
/>
```

### 4. 占位图
```vue
<img 
  :src="news.imageUrl || '/placeholder.png'" 
  @error="handleImageError"
/>
```

### 5. 图片水印
- 为爬取的图片添加网站水印
- 标识图片来源

---

## 🔍 数据验证

### 检查图片URL
```sql
-- 查看有图片的新闻数量
SELECT COUNT(*) FROM news WHERE image_url IS NOT NULL;

-- 查看图片URL示例
SELECT id, title, image_url FROM news WHERE image_url IS NOT NULL LIMIT 10;

-- 按来源统计图片
SELECT source_website, COUNT(*) as with_image
FROM news 
WHERE image_url IS NOT NULL 
GROUP BY source_website;
```

### API测试
```bash
# 获取新闻列表，查看是否包含imageUrl
GET http://localhost:8080/api/news?page=0&size=10

# 响应示例
{
  "content": [
    {
      "id": 1,
      "title": "新闻标题",
      "imageUrl": "https://news.cctv.com/image/xxx.jpg",
      ...
    }
  ]
}
```

---

## 📊 效果展示

### 新闻列表页
```
┌────────────────────────────────────┐
│ [图] 央视新闻标题                   │
│      新闻内容摘要...                │
│      央视 | 2小时前 | 125 | ♥12 | 💬5│
├────────────────────────────────────┤
│ [图] 网易新闻标题                   │
│      新闻内容摘要...                │
│      网易 | 5小时前 | 89 | ♥8 | 💬3 │
├────────────────────────────────────┤
│     没有图片的新闻标题              │
│     新闻内容摘要...                 │
│     新浪 | 1天前 | 45 | ♥2 | 💬1    │
└────────────────────────────────────┘
```

### 新闻详情页
```
┌─────────────────────────────────┐
│     新闻标题                     │
│  央视 | 2025-10-16 | 125阅读    │
│                                 │
│     [新闻配图 - 宽度800px]      │
│                                 │
│  ┌─ AI智能摘要 ─────────────┐  │
│  │ 这是AI生成的新闻摘要...   │  │
│  └───────────────────────────┘  │
│                                 │
│  新闻正文内容...                │
│                                 │
│  [点赞 (12)] [评论 (5)]         │
│                                 │
│  评论区...                      │
└─────────────────────────────────┘
```

---

## 🛠️ 维护说明

### 修改图片选择器

如果某个新闻源的图片爬取不到，可以调整选择器：

**央视新闻** (`CctvNewsCrawler.java:156`)
```java
Element imageElement = doc.selectFirst(
  "div.content_area img, " +  // 方案1
  "div.cnt_bd img, " +        // 方案2
  "img.lazy"                  // 方案3
);
```

**网易新闻** (`NeteaseNewsCrawler.java:154`)
```java
Element imageElement = doc.selectFirst(
  "div.post_body img, " +
  "div.post_text img, " +
  "img.lazyload"
);
```

### 调试技巧

1. **查看页面HTML结构**：
   - 访问新闻原网站
   - F12打开开发者工具
   - 找到图片元素，查看其class和属性
   - 更新选择器

2. **查看爬虫日志**：
```powershell
Get-Content backend\logs\news-management.log | Select-String "Found image"
```

3. **测试单个新闻源**：
```bash
POST /api/crawler/trigger/CCTV?maxCount=1
```

---

## 📋 文件清单

### 后端文件
| 文件 | 说明 | 修改类型 |
|------|------|----------|
| `V10__add_image_url.sql` | 数据库迁移 | 新增 |
| `News.java` | 实体类 | 修改（添加imageUrl字段）|
| `CctvNewsCrawler.java` | 央视爬虫 | 修改（添加图片爬取）|
| `NeteaseNewsCrawler.java` | 网易爬虫 | 修改（添加图片爬取）|

### 前端文件
| 文件 | 说明 | 修改类型 |
|------|------|----------|
| `api/news.ts` | News接口 | 修改（添加imageUrl）|
| `NewsList.vue` | 新闻列表 | 修改（显示图片+样式）|
| `NewsDetail.vue` | 新闻详情 | 修改（显示图片+样式）|

---

## 🚀 快速开始

### 1. 停止当前服务
```powershell
# 停止后端
jps -l | Select-String "NewsManagement"
taskkill /F /PID {PID}
```

### 2. 重新启动后端
```batch
cd backend
mvn spring-boot:run
```

### 3. 等待迁移完成
查看日志，应该看到：
```
Migrating schema to version "10 - add image url"
Successfully applied 10 migrations
```

### 4. 采集新闻
```powershell
.\init_test_data.ps1
```

### 5. 查看效果
访问 http://localhost:5173

---

## 💡 使用场景

### 场景1：自动采集带图新闻
```
爬虫启动 → 爬取新闻列表 → 解析新闻详情 → 
提取标题、内容、图片 → 存入数据库 → 前端展示
```

### 场景2：手动添加新闻
管理后台可以手动输入图片URL：
```
管理后台 → 新闻管理 → 创建新闻 → 
填写标题、内容、图片URL → 保存
```

---

## 🎉 功能亮点

1. **自动化**: 爬虫自动提取图片，无需人工处理
2. **智能选择**: 支持多种图片选择器，提高成功率
3. **懒加载支持**: 能爬取懒加载图片
4. **优雅降级**: 没有图片时正常显示文字内容
5. **响应式**: 图片自适应不同屏幕尺寸
6. **性能优化**: 图片压缩、懒加载

---

**准备好了！重启后端开始测试图片功能！** 🚀

```batch
cd backend
mvn spring-boot:run
```

