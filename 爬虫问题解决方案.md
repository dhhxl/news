# 🔧 爬虫问题解决方案

## 📋 问题分析

### 问题1: 数据库字段缺失错误 ✅ 已修复

**错误信息：**
```
Unknown column 'model_version' in 'field list'
```

**原因：**
`summaries` 表缺少 `model_version` 和 `status` 字段

**解决方案：**
✅ 已创建数据库迁移文件：`V7__add_summary_fields.sql`

---

### 问题2: 爬虫未采集到新闻 ⚠️ 这是正常现象

**日志分析：**
```
2025-10-14 09:02:55 - Duplicate news skipped: 我国成功发射试验三十一号卫星
2025-10-14 09:02:55 - Duplicate news skipped: 今年前三季度 我国与上合组织成员国贸易规模创新高
2025-10-14 09:02:55 - Duplicate news skipped: 新闻1+1丨应对连阴雨，如何"抢"秋收？
2025-10-14 09:02:55 - Crawl task completed for CCTV: success=0, fail=3
```

**原因说明：**
1. ✅ **爬虫工作正常**：成功从各个新闻源抓取到了新闻
2. ✅ **去重机制生效**：检测到这些新闻已经存在于数据库中
3. ✅ **系统自动跳过**：避免重复保存相同的新闻

这**不是错误**，而是系统的**智能去重**功能！

---

## 🚀 立即修复步骤

### 步骤1: 重启后端服务（应用数据库迁移）

**使用启动脚本（推荐）：**
```powershell
cd C:\Users\83932\Desktop\demo\News_website
.\stop_system.bat
.\start_system.bat
```

**或手动重启：**
```powershell
# 停止后端（在 IDE 或终端中停止）
cd backend
mvn spring-boot:run
```

重启后，Flyway 会自动执行 V7 迁移，添加缺失的字段。

---

### 步骤2: 测试智能摘要功能

数据库修复后，您可以为现有新闻生成摘要：

1. 访问：http://localhost:5173/admin/news
2. 选择任意一条新闻
3. 点击"生成摘要"按钮
4. 系统会调用智谱AI生成摘要

---

## 💡 为什么爬虫"没有采集到"新闻？

### 去重机制说明

系统有两层去重检测：

**1. 标题去重：**
```java
if (newsRepository.existsByTitle(news.getTitle())) {
    return true; // 跳过
}
```

**2. URL去重：**
```java
if (newsRepository.existsByOriginalUrl(news.getOriginalUrl())) {
    return true; // 跳过
}
```

### 查看实际情况

**方式A - 查看数据库：**
```sql
-- 查看已有新闻
SELECT id, title, source_website, publish_time 
FROM news 
ORDER BY crawl_time DESC 
LIMIT 20;

-- 查看采集历史
SELECT * FROM crawl_tasks 
ORDER BY created_at DESC 
LIMIT 10;
```

**方式B - 通过管理后台：**
1. 访问：http://localhost:5173/admin/news
2. 查看新闻列表
3. 检查是否有您刚才采集时看到的标题

---

## 🎯 如何采集到新的新闻？

### 方法1: 等待新闻源更新

新闻网站会不断发布新内容，等待一段时间后再采集：

```
建议间隔：2-4 小时
```

### 方法2: 删除部分旧新闻（测试用）

如果您只是想测试功能：

1. 访问：http://localhost:5173/admin/news
2. 删除几条现有新闻
3. 重新运行爬虫
4. 这次应该能成功采集到这些新闻

### 方法3: 清空数据库重新开始（慎用）

⚠️ **警告：这会删除所有新闻数据！**

```sql
-- 清空所有新闻（谨慎使用！）
TRUNCATE TABLE news;
TRUNCATE TABLE summaries;
TRUNCATE TABLE crawl_tasks;
```

然后重新运行爬虫。

---

## 📊 采集结果说明

### 正常的采集结果

**情况1 - 首次采集：**
```
✅ CCTV: success=5, fail=0
✅ SINA: success=3, fail=0
✅ NETEASE: success=2, fail=0
```

**情况2 - 重复采集（正常）：**
```
⚠️ CCTV: success=0, fail=5  （5条都是重复的）
⚠️ SINA: success=0, fail=3  （3条都是重复的）
```

**情况3 - 部分新内容：**
```
✅ CCTV: success=2, fail=3  （2条新的，3条重复）
```

### 采集历史查看

在管理后台的"采集管理"页面：
- **成功数**：新采集并保存的新闻
- **失败数**：重复或采集失败的新闻

---

## 🔍 验证修复

### 1. 检查数据库迁移

重启后端后，查看日志应该看到：

```
Flyway: Migrating schema to version 7 - add summary fields
Flyway: Successfully applied 1 migration
```

### 2. 测试摘要功能

```bash
# 使用PowerShell测试
cd C:\Users\83932\Desktop\demo\News_website
.\test_summary_api.ps1
```

或通过管理后台测试。

### 3. 检查爬虫状态

访问：http://localhost:5173/admin/crawler

应该能看到：
- ✅ 可用新闻源列表
- ✅ 采集历史记录
- ✅ 统计信息

---

## 📈 采集建议

### 首次使用

1. **采集少量**：先设置 maxCount=5 测试
2. **观察结果**：查看"采集历史"了解情况
3. **查看新闻**：前往"新闻管理"验证数据
4. **逐步增加**：确认正常后增加采集数量

### 日常使用

1. **定时采集**：
   - 早上 8:00 - 10条
   - 下午 14:00 - 10条
   - 晚上 20:00 - 10条

2. **间隔时间**：至少2-4小时

3. **监控去重率**：
   - 去重率 < 30%：采集频率合适
   - 去重率 > 80%：采集过于频繁，建议延长间隔

---

## 🆘 故障排除

### 数据库迁移失败

**如果重启后仍然报错：**

```sql
-- 手动执行迁移
USE news_management_db;

ALTER TABLE summaries ADD COLUMN model_version VARCHAR(50) DEFAULT 'glm-4';
ALTER TABLE summaries ADD COLUMN status VARCHAR(20) DEFAULT 'SUCCESS';
```

### 查看迁移状态

```sql
-- 查看Flyway迁移历史
SELECT * FROM flyway_schema_history ORDER BY installed_rank;
```

应该能看到 V7 版本。

### 仍然无法生成摘要

1. 检查智谱AI配置（application.yml）
2. 查看后端日志是否有其他错误
3. 确认 ZHIPUAI_API_KEY 环境变量已设置

---

## 📞 快速命令

```powershell
# 重启系统
cd C:\Users\83932\Desktop\demo\News_website
.\stop_system.bat
.\start_system.bat

# 检查服务状态
.\check_status.ps1

# 查看后端日志
Get-Content backend\logs\news-management.log -Tail 50

# 访问管理后台
start http://localhost:5173/admin/crawler
```

---

## ✅ 总结

### 问题1: 数据库错误
- **状态**：✅ 已修复
- **操作**：重启后端即可

### 问题2: 爬虫"无法采集"
- **状态**：✅ 系统正常
- **原因**：智能去重生效
- **建议**：等待新内容或删除旧新闻测试

**系统运行正常，只需重启后端应用数据库迁移即可！** 🎉

